<%- include("header", { title: post.title }) %>

<div class="mb-3">
  <button class="btn btn-link" onclick="goBack()">← Back</button>
</div>

<div class="row">
  <div class="col-md-8 mx-auto">

    <!-- POST -->
    <div class="card mb-4 shadow-sm">
      <% if (post.image) { %>
        <img
          src="/uploads/<%= post.image %>"
          class="card-img-top"
          style="max-height:400px; object-fit:cover;"
        />
      <% } %>

      <div class="card-body">
        <h2><%= post.title %></h2>

        <p class="text-muted">
          By <strong><%= post.author.name %></strong>
        </p>

        <p><%= post.content %></p>

        <!-- LIKE BUTTON -->
        <button
          id="likeBtn"
          class="btn btn-outline-danger"
        >
          ❤️ <span id="likeCount"><%= post.likes.length %></span>
        </button>
      </div>
    </div>

    <!-- COMMENTS -->
    <div class="card shadow-sm mb-5">
      <div class="card-body">
        <h5>Comments</h5>

        <% if (post.comments.length === 0) { %>
          <p class="text-muted">No comments yet.</p>
        <% } %>

        <% post.comments.forEach(comment => { %>
          <div class="border rounded p-2 mb-2">
            <strong><%= comment.author.name %></strong>
            <p class="mb-1"><%= comment.content %></p>

            <button
              class="btn btn-sm btn-outline-danger delete-btn"
              data-author="<%= comment.author._id %>"
              data-comment="<%= comment._id %>"
              style="display:none"
              onclick="deleteComment('<%= comment._id %>')"
            >
              Delete
            </button>
          </div>
        <% }) %>

        <!-- ADD COMMENT -->
        <textarea
          id="commentText"
          class="form-control mt-3 mb-2"
          placeholder="Write a comment..."
        ></textarea>

        <button
          class="btn btn-dark btn-sm mt-2"
          onclick="addComment()"
        >
          Add Comment
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  const postId = "<%= post._id %>";
  const token = localStorage.getItem("token");

  // ---- HELPERS ----
  function getUserFromToken() {
    if (!token) return null;
    return JSON.parse(atob(token.split(".")[1]));
  }

  function goBack() {
    window.history.back();
  }

  const user = getUserFromToken();
  const currentUserId = user?.id;
  const isAdmin = user?.role === "admin";

  // ---- LIKE TOGGLE ----

  const likes = <%- JSON.stringify(post.likes) %>; // this ejs is inside script tag so vscode is getting confused since its not pure js
  const likeBtn = document.getElementById("likeBtn");

  if (currentUserId && likes.includes(currentUserId)) {
    likeBtn.classList.remove("btn-outline-danger");
    likeBtn.classList.add("btn-danger");
  }

  likeBtn.addEventListener("click", async () => {
    if (!token) {
      alert("Login required");
      return;
    }

    await fetch(`/api/posts/${postId}/like`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    location.reload();
  });

  // ---- ADD COMMENT ----
  async function addComment() {
    if (!token) {
      alert("Login required");
      return;
    }

    const text = document.getElementById("commentText").value.trim();
    if (!text) return;

    await fetch(`/api/posts/${postId}/comment`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ text })
    });

    location.reload();
  }

  // ---- DELETE COMMENT (UI CONTROL) ----
  document.querySelectorAll(".delete-btn").forEach(btn => {
    const authorId = btn.dataset.author;
    if (currentUserId && (authorId === currentUserId || isAdmin)) {
      btn.style.display = "inline-block";
    }
  });

  async function deleteComment(commentId) {
    if (!token) return;

    await fetch(`/api/posts/${postId}/comment/${commentId}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    location.reload();
  }
</script>

<%- include("footer") %>
